#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="/opt/provision-kit"
SECTOR_DIR="$BASE_DIR/sectors"
CONFIG_FILE="/etc/provision-kit/provision.conf"
MARKER_DIR="/var/lib/provision-kit"
BACKUP_DIR="/var/backups/provision-kit"
VERSION_FILE="$BASE_DIR/VERSION"

run_sector() {
  local script="$1"
  if [[ ! -x "$script" ]]; then
    echo "Missing or non-executable sector: $script"
    return 1
  fi

  if [[ $(id -u) -ne 0 ]]; then
    if ! sudo "$script"; then
      echo "Sector failed: $script"
      return 1
    fi
  else
    if ! "$script"; then
      echo "Sector failed: $script"
      return 1
    fi
  fi
}

current_version() {
  if [[ -f "$VERSION_FILE" ]]; then
    tr -d '[:space:]' < "$VERSION_FILE"
  else
    echo "unknown"
  fi
}

prompt_and_set_admin_password() {
  local pw1 pw2
  while true; do
    read -rsp "Set ADMIN_SUDO_PASSWORD (min 6 chars): " pw1
    echo
    if [[ ${#pw1} -lt 6 ]]; then
      echo "Invalid password format."
      continue
    fi
    read -rsp "Confirm ADMIN_SUDO_PASSWORD: " pw2
    echo
    if [[ "$pw1" != "$pw2" ]]; then
      echo "Passwords did not match."
      continue
    fi
    break
  done

  if [[ $(id -u) -ne 0 ]]; then
    if ! sudo test -f "$CONFIG_FILE"; then
      echo "Cannot update $CONFIG_FILE without sudo access."
      return 1
    fi
    if sudo grep -q '^ADMIN_SUDO_PASSWORD=' "$CONFIG_FILE"; then
      sudo sed -i "s|^ADMIN_SUDO_PASSWORD=.*$|ADMIN_SUDO_PASSWORD=\"$pw1\"|" "$CONFIG_FILE"
    else
      echo "ADMIN_SUDO_PASSWORD=\"$pw1\"" | sudo tee -a "$CONFIG_FILE" >/dev/null
    fi
  else
    if grep -q '^ADMIN_SUDO_PASSWORD=' "$CONFIG_FILE"; then
      sed -i "s|^ADMIN_SUDO_PASSWORD=.*$|ADMIN_SUDO_PASSWORD=\"$pw1\"|" "$CONFIG_FILE"
    else
      echo "ADMIN_SUDO_PASSWORD=\"$pw1\"" >> "$CONFIG_FILE"
    fi
  fi

  echo "ADMIN_SUDO_PASSWORD has been set in config."
}

ensure_admin_password_configured() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Config not found: $CONFIG_FILE"
    return 1
  fi

  local current_pw
  if [[ $(id -u) -ne 0 ]]; then
    current_pw="$(sudo awk -F= '/^ADMIN_SUDO_PASSWORD=/{print $2}' "$CONFIG_FILE" 2>/dev/null | tail -n1 | tr -d '\"')"
  else
    current_pw="$(awk -F= '/^ADMIN_SUDO_PASSWORD=/{print $2}' "$CONFIG_FILE" | tail -n1 | tr -d '\"')"
  fi

  if [[ -z "$current_pw" ]]; then
    echo "ADMIN_SUDO_PASSWORD is not set."
    prompt_and_set_admin_password || return 1
  fi
}

run_recommended_sequence() {
  run_sector "$SECTOR_DIR/00-tailscale.sh"
  run_sector "$SECTOR_DIR/10-user-ssh.sh"
  run_sector "$SECTOR_DIR/15-ssh-access.sh"
  run_sector "$SECTOR_DIR/20-baseline-os.sh"
  run_sector "$SECTOR_DIR/90-verify.sh"
}

show_status() {
  echo "Completion markers:"
  if [[ $(id -u) -ne 0 ]]; then
    sudo ls -1 "$MARKER_DIR" 2>/dev/null || echo "(none)"
  else
    ls -1 "$MARKER_DIR" 2>/dev/null || echo "(none)"
  fi

  echo
  echo "Quick checks:"
  if command -v tailscale >/dev/null 2>&1; then
    tailscale ip -4 2>/dev/null || true
  else
    echo "tailscale: not installed"
  fi

  if command -v ufw >/dev/null 2>&1; then
    if [[ $(id -u) -ne 0 ]]; then
      sudo ufw status 2>/dev/null | head -n 1 || true
    else
      ufw status 2>/dev/null | head -n 1 || true
    fi
  else
    echo "ufw: not installed"
  fi
}

backup_runtime_config() {
  local ts
  ts="$(date -u +%Y%m%dT%H%M%SZ)"
  local target="$BACKUP_DIR/$ts"

  if [[ $(id -u) -ne 0 ]]; then
    sudo mkdir -p "$target"
    [[ -f /etc/provision-kit/provision.conf ]] && sudo cp -a /etc/provision-kit/provision.conf "$target/"
    [[ -f /etc/ssh/sshd_config ]] && sudo cp -a /etc/ssh/sshd_config "$target/"
    [[ -d /etc/ssh/sshd_config.d ]] && sudo cp -a /etc/ssh/sshd_config.d "$target/"
    [[ -f /etc/ufw/user.rules ]] && sudo cp -a /etc/ufw/user.rules "$target/"
    [[ -f /etc/ufw/user6.rules ]] && sudo cp -a /etc/ufw/user6.rules "$target/"
    [[ -f /etc/ufw/before.rules ]] && sudo cp -a /etc/ufw/before.rules "$target/"
    [[ -f /etc/ufw/before6.rules ]] && sudo cp -a /etc/ufw/before6.rules "$target/"
  else
    mkdir -p "$target"
    [[ -f /etc/provision-kit/provision.conf ]] && cp -a /etc/provision-kit/provision.conf "$target/"
    [[ -f /etc/ssh/sshd_config ]] && cp -a /etc/ssh/sshd_config "$target/"
    [[ -d /etc/ssh/sshd_config.d ]] && cp -a /etc/ssh/sshd_config.d "$target/"
    [[ -f /etc/ufw/user.rules ]] && cp -a /etc/ufw/user.rules "$target/"
    [[ -f /etc/ufw/user6.rules ]] && cp -a /etc/ufw/user6.rules "$target/"
    [[ -f /etc/ufw/before.rules ]] && cp -a /etc/ufw/before.rules "$target/"
    [[ -f /etc/ufw/before6.rules ]] && cp -a /etc/ufw/before6.rules "$target/"
  fi

  echo "Backup created at: $target"
}

reset_markers() {
  read -rp "Delete all completion markers in $MARKER_DIR? (y/n): " yn
  [[ "$yn" =~ ^[yY]$ ]] || return 0

  if [[ $(id -u) -ne 0 ]]; then
    sudo rm -f "$MARKER_DIR"/*.done
  else
    rm -f "$MARKER_DIR"/*.done
  fi
  echo "Markers reset."
}

print_effective_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Config not found: $CONFIG_FILE"
    return 1
  fi

  if [[ $(id -u) -ne 0 ]]; then
    sudo awk 'NF && $1 !~ /^#/' "$CONFIG_FILE"
  else
    awk 'NF && $1 !~ /^#/' "$CONFIG_FILE"
  fi
}

run_unit_tests() {
  local tester="$BASE_DIR/tests/tester"
  if [[ ! -f "$tester" ]]; then
    echo "Tester not found: $tester"
    return 1
  fi
  if ! command -v bash >/dev/null 2>&1; then
    echo "bash is required to run tests."
    return 1
  fi

  bash "$tester"
}

restart_now() {
  read -rp "Restart this machine immediately? (y/n): " yn
  [[ "$yn" =~ ^[yY]$ ]] || return 0

  if [[ $(id -u) -ne 0 ]]; then
    sudo systemctl reboot
  else
    systemctl reboot
  fi
}

pick_editor() {
  if [[ -n "${EDITOR:-}" ]]; then
    echo "$EDITOR"
    return 0
  fi
  if command -v nano >/dev/null 2>&1; then
    echo "nano"
    return 0
  fi
  if command -v vi >/dev/null 2>&1; then
    echo "vi"
    return 0
  fi
  return 1
}

edit_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Config not found: $CONFIG_FILE"
    return 1
  fi

  if [[ $(id -u) -ne 0 ]]; then
    if command -v sudoedit >/dev/null 2>&1; then
      sudoedit "$CONFIG_FILE"
      return $?
    fi
    local editor
    if ! editor="$(pick_editor)"; then
      echo "No editor found. Set EDITOR or install nano/vi."
      return 1
    fi
    sudo "$editor" "$CONFIG_FILE"
    return $?
  fi

  local editor
  if ! editor="$(pick_editor)"; then
    echo "No editor found. Set EDITOR or install nano/vi."
    return 1
  fi
  "$editor" "$CONFIG_FILE"
}

while true; do
  ensure_admin_password_configured || exit 1
  clear || true
  VERSION="$(current_version)"
  echo "===================================="
  echo " Provision Kit v$VERSION"
  echo "===================================="
  echo "1) Edit Config"
  echo "2) Run Recommended Sequence (optional)"
  echo "3) Tailscale Bootstrap"
  echo "4) Admin User + SSH Setup"
  echo "5) SSH Access Policy"
  echo "6) Baseline OS"
  echo "7) Verify Posture"
  echo "8) Show Status"
  echo "9) Backup SSH/UFW/Provision Config"
  echo "10) Reset Completion Markers"
  echo "11) Print Effective Config"
  echo "12) Change Server Hostname"
  echo "13) Rotate User SSH Key"
  echo "14) Run Unit Tests"
  echo "15) Enforce Compliance Check"
  echo "16) Restart Machine Now"
  echo "17) Update Provision Kit from GitHub"
  echo "18) Toggle Ping Policy"
  echo "19) Repair SSH Auth Override"
  echo "20) Guided Posture Audit (Manual)"
  echo "21) Selector Guide"
  echo "q) Quit"
  echo "------------------------------------"
  read -rp "Select: " opt

  case "$opt" in
    1) edit_config ;;
    2) run_recommended_sequence ;;
    3) run_sector "$SECTOR_DIR/00-tailscale.sh" ;;
    4) run_sector "$SECTOR_DIR/10-user-ssh.sh" ;;
    5) run_sector "$SECTOR_DIR/15-ssh-access.sh" ;;
    6) run_sector "$SECTOR_DIR/20-baseline-os.sh" ;;
    7) run_sector "$SECTOR_DIR/90-verify.sh" ;;
    8) show_status ;;
    9) backup_runtime_config ;;
    10) reset_markers ;;
    11) print_effective_config ;;
    12) run_sector "$SECTOR_DIR/25-hostname.sh" ;;
    13) run_sector "$SECTOR_DIR/11-ssh-key-rotate.sh" ;;
    14) run_unit_tests ;;
    15) run_sector "$SECTOR_DIR/95-compliance-check.sh" ;;
    16) restart_now ;;
    17) run_sector "$SECTOR_DIR/05-update-kit.sh" ;;
    18) run_sector "$SECTOR_DIR/30-ping-policy.sh" ;;
    19) run_sector "$SECTOR_DIR/16-ssh-auth-repair.sh" ;;
    20) run_sector "$SECTOR_DIR/91-guided-posture-audit.sh" ;;
    21) run_sector "$SECTOR_DIR/92-selector-guide.sh" ;;
    q|Q) exit 0 ;;
    *) echo "Invalid selection." ;;
  esac

  read -rp "Run another selector? (Y/n): " again
  [[ -z "$again" || "$again" =~ ^[yY]$ ]] || exit 0
done
